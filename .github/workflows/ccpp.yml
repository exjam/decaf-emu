name: C/C++ CI

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
      with:
        submodules: true
    - name: initialise
      run: mkdir build
    - name: apt
      run: |
        wget -qO - http://packages.lunarg.com/lunarg-signing-key-pub.asc | sudo apt-key add -
        sudo wget -qO /etc/apt/sources.list.d/lunarg-vulkan-bionic.list http://packages.lunarg.com/vulkan/lunarg-vulkan-bionic.list
        sudo apt update
        sudo apt install cmake libcurl4-openssl-dev libsdl2-dev libssl-dev zlib1g-dev libavcodec-dev libavfilter-dev libavutil-dev libswscale-dev vulkan-sdk
    - name: conan
      run: |
        cd build
        pip install --user conan
        source ~/.profile
        conan user
        conan remote add bincrafters https://api.bintray.com/conan/bincrafters/public-conan || true
        conan install .. --build=missing -o silent=True -o ffmpeg=True -o curl=False -o openssl=False -o sdl2=False -o zlib=False
      env:
        CC: clang-6.0
        CXX: clang++-6.0
        CONAN_COMPILER: clang
        CONAN_COMPILER_VERSION: 6.0
    - name: cmake
      run: |
        cd build
        cmake -DDECAF_BUILD_TOOLS=ON -DDECAF_FFMPEG=ON -DDECAF_VULKAN=ON -DCMAKE_BUILD_TYPE=Release ..
      env:
        CC: clang-6.0
        CXX: clang++-6.0
        CONAN_COMPILER: clang
        CONAN_COMPILER_VERSION: 6.0
    - name: make
      run: |
        cd build
        make -j2
      env:
        CC: clang-6.0
        CXX: clang++-6.0
        CONAN_COMPILER: clang
        CONAN_COMPILER_VERSION: 6.0
